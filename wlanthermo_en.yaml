button_card_templates:
  wlt_channel_button:
    variables:
      device_name: wlanthermo
    show_icon: true
    show_name: true
    show_state: false
    icon: mdi:thermometer
    name: |
      [[[
          const id = parseInt(entity.entity_id.match(/channel_(\d+)_/)[1]);
          const dev = variables.device_name;
          const temp = entity.state !== 'unavailable' ? entity.state + "°C" : "N/A";
          return states[`text.${dev}_kanal_${id}_name`]?.state + "  " + temp;
      ]]]
    custom_fields:
      time_left: |
        [[[
          const id = entity.entity_id.match(/channel_(\d+)_/)[1];
          const dev = variables.device_name;
          const tl = states[`sensor.${dev}_channel_${id}_time_left`];
          return tl.state != 0 ? `Time left: ${tl.state}` : "Time left: ~ ";
        ]]]
      minmax: |
        [[[
          const id = entity.entity_id.match(/channel_(\d+)_/)[1];
          const dev = variables.device_name;
          const min = states[`number.${dev}_channel_${id}_minimum`]?.state;
          const max = states[`number.${dev}_channel_${id}_maximum`]?.state;
          return `
            <div style="
              display:flex;
              align-items:center;
              justify-content:space-between;
              width:100%;
              font-size:13px;
            ">
              <span style="display:flex; align-items:center; gap:4px;">
                <ha-icon icon="mdi:chevron-down"style="--mdc-icon-size:14px;"></ha-icon>
                ${min}°C
              </span>
              <span style="display:flex; align-items:center; gap:4px;">
                <ha-icon icon="mdi:chevron-up"style="--mdc-icon-size:14px;"></ha-icon>
                ${max}°C
              </span>
            </div>
          `;
        ]]]
    styles:
      grid:
        - grid-template-areas: '"i n" "i minmax" "i time_left"'
        - grid-template-columns: 30px 1fr
        - grid-template-rows: auto auto
        - row-gap: 2px
      card:
        - padding: 4px
        - height: 70px
        - border-radius: 12px
        - background-color: |
            [[[
              const id = entity.entity_id.match(/channel_(\d+)_/)[1];
              const dev = variables.device_name;

              const temp = parseFloat(states[`sensor.${dev}_channel_${id}_temperature`]?.state);
              const max  = parseFloat(states[`number.${dev}_channel_${id}_maximum`]?.state);

              if (isNaN(temp) || isNaN(max)) {
                return "rgba(250,250,0,0.3)";  // fallback for missing values
              }

              return temp < max
                ? "rgba(0,150,0,0.3)"   // green
                : "rgba(150,0,0,0.3)";  // red
            ]]]
      name:
        - font-size: 14px
        - font-weight: bold
        - grid-area: 'n'
        - align-self: end
      custom_fields:
        time_left:
          - font-size: 12px
          - grid-area: time_left
          - align-self: start
        minmax:
          - grid-area: minmax
          - align-self: start
          - font-size: 12px
      icon:
        - width: 22px
        - height: 22px
        - grid-area: i
        - align-self: center
    tap_action:
      action: fire-dom-event
      browser_mod:
        service: browser_mod.popup
        data:
          title: |
            [[[
              const id = entity.entity_id.match(/channel_(\d+)_/)[1];
              return "Channel " + id;
            ]]]
          content:
            type: entities
            entities:
              - |
                [[[
                  const id = entity.entity_id.match(/channel_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `sensor.${dev}_channel_${id}_temperature`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/channel_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `sensor.${dev}_channel_${id}_time_left`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/channel_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `text.${dev}_channel_${id}_name`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/channel_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `number.${dev}_channel_${id}_minimum`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/channel_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `number.${dev}_channel_${id}_maximum`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/channel_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `select.${dev}_channel_${id}_alarm_mode`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/channel_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `light.${dev}_channel_${id}_color`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/channel_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `select.${dev}_channel_${id}_probe_type`;
                ]]]
  wlt_pitmaster_button:
    show_icon: true
    show_name: true
    show_state: false
    icon: mdi:thermometer
    variables:
      device_name: wlanthermo
    name: |
      [[[
        const id = parseInt(entity.entity_id.match(/pitmaster_(\d+)_/)[1]);
        const temp = entity.state !== 'unavailable' ? entity.state + "°C" : "N/A";
        return "Pitmaster " + (id + 1) + "  " + temp;
      ]]]
    custom_fields:
      time_left: |
        [[[ 
          const id = entity.entity_id.match(/pitmaster_(\d+)_/)[1];
          const dev = variables.device_name;
          const tl = states[`sensor.${dev}_pitmaster_${id}_power`];
          return tl.state != 0 ? `Speed: ${tl.state} %` : "Speed: ~ ";
        ]]]
      max: |
        [[[
          const id = entity.entity_id.match(/pitmaster_(\d+)_/)[1];
          const dev = variables.device_name;
          const max = states[`number.${dev}_pitmaster_${id}_power`]?.state;
          return `
            <div style="
              display:flex;
              align-items:center;
              justify-content:space-between;
              width:100%;
              font-size:13px;
            ">
              <span style="display:flex; align-items:center; gap:4px;">
                <ha-icon icon="mdi:chevron-up"style="--mdc-icon-size:14px;"></ha-icon>
                ${max}°C
              </span>
            </div>
          `;
        ]]]
    styles:
      grid:
        - grid-template-areas: '"i n" "i max" "i time_left"'
        - grid-template-columns: 30px 1fr
        - grid-template-rows: auto auto
        - row-gap: 2px
      card:
        - padding: 4px
        - height: 70px
        - border-radius: 12px
        - background-color: |
            [[[
              return entity && entity.state !== 'unavailable'
                ? 'rgba(0,150,0,0.3)'
                : 'rgba(150,0,0,0.3)';
            ]]]
      name:
        - font-size: 14px
        - font-weight: bold
        - grid-area: 'n'
        - align-self: end
      custom_fields:
        time_left:
          - font-size: 12px
          - grid-area: time_left
          - align-self: start
        max:
          - font-size: 12px
          - grid-area: max
          - justify-self: end
          - align-self: start
      icon:
        - width: 22px
        - height: 22px
        - grid-area: i
        - align-self: center
    tap_action:
      action: fire-dom-event
      browser_mod:
        service: browser_mod.popup
        data:
          title: |
            [[[
              const id = entity.entity_id.match(/pitmaster_(\d+)_/)[1];
              return "Pitmaster " + id;
            ]]]
          content:
            type: entities
            entities:
              - |
                [[[
                  const id = entity.entity_id.match(/pitmaster_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `number.${dev}_pitmaster_${id}_power`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/pitmaster_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `number.${dev}_pitmaster_${id}_temperature`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/pitmaster_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `select.${dev}_pitmaster_${id}_channel`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/pitmaster_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `select.${dev}_pitmaster_${id}_pid_profile`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/pitmaster_(\d+)_/)[1];
                  const dev = variables.device_name;
                  return `select.${dev}_pitmaster_${id}_mode`;
                ]]]
  wlt_pitprofil_button:
    show_icon: false
    show_name: true
    show_state: false
    icon: mdi:thermometer
    variables:
      device_name: wlanthermo
    name: |
      [[[
        const dev = variables.device_name;
        const id = entity.entity_id.match(/pid_profil_(\d+)_/)[1];
        return states[`text.${dev}_pid_profil_${id}_name`]?.state;
      ]]]
    styles:
      card:
        - padding: 4px
        - height: 70px
        - border-radius: 12px
      name:
        - font-size: 14px
        - font-weight: bold
        - align-self: center
      icon:
        - width: 22px
        - height: 22px
    tap_action:
      action: fire-dom-event
      browser_mod:
        service: browser_mod.popup
        data:
          title: |
            [[[
              const id = entity.entity_id.match(/pid_profil_(\d+)_/)[1];
              return "Pit Profile " + id;
            ]]]
          content:
            type: entities
            entities:
              - |
                [[[
                  const id = entity.entity_id.match(/pid_profil_(\d+)_/)[1];
                  return `text.${variables.device_name}_pid_profil_${id}_name`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/pid_profil_(\d+)_/)[1];
                  return `select.${variables.device_name}_pid_profil_${id}_actuator`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/pid_profil_(\d+)_/)[1];
                  return `switch.${variables.device_name}_pid_profil_${id}_open_lid_detection`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/pid_profil_(\d+)_/)[1];
                  return `number.${variables.device_name}_pid_profil_${id}_jump_power_jp`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/pid_profil_(\d+)_/)[1];
                  return `number.${variables.device_name}_pid_profil_${id}_pwm_minimum`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/pid_profil_(\d+)_/)[1];
                  return `number.${variables.device_name}_pid_profil_${id}_pwm_maximum`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/pid_profil_(\d+)_/)[1];
                  return `number.${variables.device_name}_pid_profil_${id}_servo_minimum`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/pid_profil_(\d+)_/)[1];
                  return `number.${variables.device_name}_pid_profil_${id}_servo_maximum`;
                ]]]
              - |
                [[[
                  const id = entity.entity_id.match(/pid_profil_(\d+)_/)[1];
                  return `switch.${variables.device_name}_pid_profil_${id}_actuator_link`;
                ]]]
  wlt_notification_button:
    show_icon: false
    show_name: true
    show_state: false
    icon: mdi:thermometer
    variables:
      device_name: wlanthermo
    name: |
      [[[
        return "Notifications";
      ]]]
    styles:
      card:
        - padding: 4px
        - height: 70px
        - border-radius: 12px
        - background: |
            [[[
              const pushover = states['switch.wlanthermo_push_pushover_activ']?.state === 'on';
              const telegram = states['switch.wlanthermo_push_telegram_activ']?.state === 'on';
              const left = pushover ? 'rgba(0,180,0,0.6)' : 'rgba(200,0,0,0.6)';
              const right = telegram ? 'rgba(0,180,0,0.6)' : 'rgba(200,0,0,0.6)';
              return `
                linear-gradient(
                  to right,
                  ${left},
                  ${right}
                )
              `;
            ]]]
      name:
        - font-size: 14px
        - font-weight: bold
        - align-self: center
      icon:
        - width: 22px
        - height: 22px
    tap_action:
      action: fire-dom-event
      browser_mod:
        service: browser_mod.popup
        data:
          title: Notifications
          content:
            type: entities
            entities:
              - switch.wlanthermo_push_pushover_activ
              - select.wlanthermo_push_pushover_prioritat
              - text.wlanthermo_push_pushover_token
              - text.wlanthermo_push_pushover_user_key
              - button.wlanthermo_push_pushover_test
              - switch.wlanthermo_push_telegram_activ
              - text.wlanthermo_push_telegram_token
              - text.wlanthermo_push_telegram_chat_id
              - button.wlanthermo_push_telegram_test
  wlt_bluetooth_button:
    show_icon: false
    show_name: true
    show_state: false
    icon: mdi:thermometer
    variables:
      device_name: wlanthermo
    name: |
      [[[
        return "Bluetooth";
      ]]]
    styles:
      card:
        - padding: 4px
        - height: 70px
        - border-radius: 12px
        - background-repeat: no-repeat
        - background-size: 100% 30%, 100% 40%, 100% 30%
        - background-position: bottom, center, top
        - background: |
            [[[
              const bt = states['switch.wlanthermo_bluetooth_aktiv']?.state === 'on';

              // Bluetooth OFF → Card red
              if (!bt) {
                return 'linear-gradient(to right, rgba(200,0,0,1), rgba(200,0,0,1))';
              }

              // Bluetooth ON → Sensor-Filds
              const sensors = [
                'switch.wlanthermo_bluetooth_phyrawadv_03c9_sensor_1',
                'switch.wlanthermo_bluetooth_phyrawadv_03c9_sensor_2',
                'switch.wlanthermo_bluetooth_phyrawadv_03c9_sensor_3',
                'switch.wlanthermo_bluetooth_phyrawadv_03c9_sensor_4',
                'switch.wlanthermo_bluetooth_phyrawadv_03c9_sensor_5',
                'switch.wlanthermo_bluetooth_phyrawadv_03c9_sensor_6'
              ];

              // Farbe pro Sensor
              const colors = sensors.map(id =>
                states[id]?.state === 'on'
                  ? 'rgba(0,180,0,1)'   // aktiv → green
                  : 'rgba(200,0,0,1)'   // inaktiv → red
              );

              // Zwischen-Fades (20% transparent)
              const fades = colors.map(c => c.replace(',1)', ',0.8)'));

              // Gradient build: color1, fade1, color2, fade2, ...
              const parts = [];
              for (let i = 0; i < colors.length; i++) {
                parts.push(colors[i]);
                parts.push(colors[i]);
                if (i < fades.length - 1) parts.push(fades[i]);
              }
                parts.push(colors[colors.length-1]);

              return `linear-gradient(to right, ${parts.join(',')})`;
            ]]]
      name:
        - font-size: 14px
        - font-weight: bold
        - align-self: center
      icon:
        - width: 22px
        - height: 22px
    tap_action:
      action: fire-dom-event
      browser_mod:
        service: browser_mod.popup
        data:
          title: Bluetooth
          content:
            type: entities
            entities:
              - switch.wlanthermo_bluetooth_aktiv
              - switch.wlanthermo_bluetooth_phyrawadv_03c9_sensor_1
              - switch.wlanthermo_bluetooth_phyrawadv_03c9_sensor_2
              - switch.wlanthermo_bluetooth_phyrawadv_03c9_sensor_3
              - switch.wlanthermo_bluetooth_phyrawadv_03c9_sensor_4
              - switch.wlanthermo_bluetooth_phyrawadv_03c9_sensor_5
              - switch.wlanthermo_bluetooth_phyrawadv_03c9_sensor_6
views:
  - title: WLANThermo
    path: wlanthermo
    type: panel
    icon: mdi:grill
    cards:
      - type: grid
        columns: 1
        square: false
        cards:
          - type: custom:auto-entities
            card:
              type: grid
              columns: 8
              square: false
            filter:
              include:
                - entity_id: sensor.wlanthermo_channel_*_temperature
                  options:
                    type: custom:button-card
                    template: wlt_channel_button
              exclude:
                - state: unavailable
                - state: unknown
              sort:
                method: attribute
                attribute: id
                numeric: true
            card_param: cards
          - type: grid
            columns: 2
            square: false
            cards:
              - type: grid
                columns: 1
                square: false
                cards:
                  - type: custom:auto-entities
                    card:
                      type: history-graph
                      hours_to_show: 1
                      fit_y_data: false
                      min_y_axis: 10
                      max_y_axis: 100
                    filter:
                      include:
                        - entity_id: sensor.wlanthermo_channel_*_temperature
                      exclude:
                        - state: unavailable
                        - state: unknown
                    sort:
                      method: entity_id
                    card_param: entities
              - type: grid
                columns: 1
                square: false
                cards:
                  - type: custom:auto-entities
                    card:
                      type: grid
                      columns: 2
                      square: false
                    filter:
                      include:
                        - entity_id: sensor.wlanthermo_pitmaster_*_temperature
                          options:
                            type: custom:button-card
                            template: wlt_pitmaster_button
                      exclude:
                        - state: unavailable
                        - state: unknown
                    sort:
                      method: entity_id
                    card_param: cards
                  - type: grid
                    columns: 4
                    square: false
                    cards:
                      - type: custom:mushroom-entity-card
                        entity: sensor.wlanthermo_battery_level
                        name: Battery %
                        icon: mdi:battery
                        card_mod:
                          style: |
                            ha-card {
                              border-radius: 12px;
                              padding: 8px;
                              background-color:
                                {% set v = states('sensor.wlanthermo_battery_level') | int(default=0) %}
                                {% if v > 60 %}
                                  rgba(0,200,0,0.3)
                                {% elif v > 30 %}
                                  rgba(255,200,0,0.3)
                                {% else %}
                                  rgba(200,0,0,0.3)
                                {% endif %};
                            }
                      - type: custom:mushroom-entity-card
                        entity: sensor.wlanthermo_signal_strength
                        name: WiFi Signal
                        icon: mdi:wifi
                        card_mod:
                          style: |
                            ha-card {
                              border-radius: 12px;
                              padding: 8px;
                              background-color:
                                {% set v = states('sensor.wlanthermo_signal_strength') | int(default=0) %}
                                {% if v > -60 %}
                                  rgba(0,200,0,0.3)
                                {% elif v > -75 %}
                                  rgba(255,200,0,0.3)
                                {% else %}
                                  rgba(200,0,0,0.3)
                                {% endif %};
                            }
                      - type: custom:mushroom-entity-card
                        entity: sensor.wlanthermo_cloud_status
                        name: Online
                        icon: mdi:cloud
                        card_mod:
                          style: |
                            ha-card {
                              border-radius: 12px;
                              padding: 8px;
                              background-color:
                                {% set v = states('sensor.wlanthermo_cloud_status') %}
                                {% if v == 'verbunden' or v == 'connected' %}
                                  rgba(0,200,0,0.3)
                                {% elif v == 'standby' %}
                                  rgba(255,200,0,0.3)
                                {% else %}
                                  rgba(200,0,0,0.3)
                                {% endif %};
                            }
                      - type: custom:mushroom-entity-card
                        entity: sensor.wlanthermo_system_info
                        name: System Info
                        icon: mdi:cog-outline
                        card_mod:
                          style: |
                            ha-card {
                              border-radius: 12px;
                              padding: 8px;
                            }
                      - type: custom:mushroom-entity-card
                        entity: sensor.wlanthermo_battery_charging
                        name: Charging
                        icon: mdi:power-plug
                        card_mod:
                          style: |
                            ha-card {
                              border-radius: 12px;
                              padding: 8px;
                              background-color:
                                {% set charging = states('sensor.wlanthermo_battery_charging') %}
                                {% set soc = states('sensor.wlanthermo_battery_level') | int(0) %}
                                {% if charging in ['true','on','online','connected','True','1'] %}
                                  rgba(0,200,0,0.3)     /* charging */
                                {% elif charging in ['false','off','False','0'] and soc == 100 %}
                                  rgba(0,150,255,0.3)   /* plugged, full */
                                {% elif charging in ['false','off','False','0'] %}
                                  rgba(200,200,0,0.3)   /* battery */
                                {% else %}
                                  rgba(150,150,150,0.3)
                                {% endif %};
                            }
                      - type: custom:mushroom-entity-card
                        entity: sensor.wlanthermo_cloud_link
                        name: Cloud URL
                        icon: mdi:web
                        card_mod:
                          style: |
                            ha-card {
                              border-radius: 12px;
                              padding: 8px;
                              background-color:
                                {% set v = states('sensor.wlanthermo_cloud_link') %}
                                {% if v and v != 'unavailable' %}
                                  rgba(0,200,0,0.3)
                                {% else %}
                                  rgba(200,0,0,0.3)
                                {% endif %};
                            }
                      - type: custom:mushroom-entity-card
                        entity: sensor.wlanthermo_system_time
                        name: Time
                        icon: mdi:clock
                        card_mod:
                          style: |
                            ha-card {
                              border-radius: 12px;
                              padding: 8px;
                            }
                      - type: custom:mushroom-entity-card
                        entity: sensor.wlanthermo_device_info
                        name: Device Info
                        icon: mdi:devices
                        card_mod:
                          style: |
                            ha-card {
                              border-radius: 12px;
                              padding: 8px;
                            }
                  - type: custom:auto-entities
                    card:
                      type: grid
                      columns: 4
                      square: false
                    filter:
                      include:
                        - entity_id: text.wlanthermo_pid_profil_*_name
                          options:
                            type: custom:button-card
                            template: wlt_pitprofil_button
                    sort:
                      method: entity_id
                    card_param: cards
                  - type: grid
                    columns: 2
                    square: false
                    cards:
                      - type: custom:button-card
                        entity: switch.wlanthermo_push_pushover_aktiv
                        name: Notifications
                        icon: mdi:battery
                        template: wlt_notification_button
                      - type: custom:button-card
                        entity: switch.wlanthermo_bluetooth_aktiv
                        name: Bluetooth
                        icon: mdi:battery
                        template: wlt_bluetooth_button
          - type: custom:auto-entities
            card:
              type: custom:apexcharts-card
              update_interval: 5sec
              header:
                show: false
                show_states: true
              apex_config:
                chart:
                  height: 400
              yaxis:
                - id: '1'
                  opposite: true
                  min: 0
                  max: 100
                - id: '0'
                  min: 0
                  max: 200
                  opposite: false
            filter:
              exclude:
                - state: unavailable
                - state: unknown
              include:
                - entity_id: sensor.wlanthermo_pitmaster_*_power
                  options:
                    yaxis_id: '1'
                    stroke_width: 1
                    type: area
                    opacity: 0.25
                    curve: stepline
                - entity_id: sensor.wlanthermo_pitmaster_*_temperature
                  options:
                    yaxis_id: '0'
                    stroke_width: 1
                - entity_id: sensor.wlanthermo_channel_*_temperature
                  options:
                    yaxis_id: '0'
                    stroke_width: 3
            sort:
              method: entity_id
            card_param: series
